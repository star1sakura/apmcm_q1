先说结论：你现在这套附件，其实天然分成三块数据源——

1. **年度关税数据库（tariff_database_xxxx）**
2. **关税字段说明 + 代码表（td-fields.pdf / td-codes.pdf）**
3. **DataWeb 贸易数据：出口 FAS Value & General Import Charges（相当于关税收入）**

下面我给一个**五题共用的一套“从原始文件到可建模数据”的基础清洗方案**，你后面做大豆/汽车/芯片/关税收入/宏观传导，全部都在这套框架上加专门处理即可。

---

## 一、整体规范：统一命名 & 粒度

### 1. 代码与维度

* **商品代码（HTS/HS）**

  * Tariff DB 里是 `HTS8`：8 位关税线编码，是法律意义上的最低级编码。
  * 清洗时强制：

    * `hts8`：字符串，左侧补零到 8 位（例如 `1012100` → `"01012100"`）。
    * `hs2 = hts8[:2]`（章），`hs4 = hts8[:4]`（税目），`hs6 = hts8[:6]`。
* **时间维度**

  * Tariff：按“年度 + 生效区间”。

    * 你有 2015–2025 多个年度文件，如 `tariff_database_202010.xlsx`、`tariff database_202106.xlsx`、`tariff_database_2025.xlsx` 等。
    * 清洗后统一在一个变量 `year`（整数，2020–2025）上，后续所有建模都以“年”为基本时间单位。
  * 贸易：DataWeb 导出的文件是**年度宽表**（2020–2025 列），转换成长表 `year` + `value`。
* **国家/地区维度**

  * DataWeb 表里是文本国家名，例如 `Afghanistan`、`Antigua and Barbuda` 等（在 `Country` 列）。
  * 建议统一：

    * `partner_name`：原英文国名；
    * `partner_iso3`：统一映射到 ISO3 代码，便于后面接 GDP、汇率等外部数据。

### 2. 指标命名

统一一套可复用的变量名：

* 关税侧：

  * `mfn_adval`：MFN 从价税率（小数，例如 0.05 表示 5%）
  * `mfn_spec_q1`, `mfn_spec_q2`, `mfn_other`：按 USITC 字段说明中的 specific/other 部分存储，源自 `MFN_SPECIFIC_RATE`、`MFN_OTHER_RATE` 等。([USITC][1])
  * `rate_type_code`：关税计算方式（0=free；1=只用Q1 specific；4=“specific*Q1 + ad_val*Value”等），来自 `*_RATE_TYPE_CODE` 字段，对照 `td-codes.pdf`。
* 贸易侧：

  * `export_fas`：美国对各国**总出口 FAS Value**（DataWeb 的 FAS 定义）。([DataWeb][2])
  * `import_duty`：General Import Charges（关税收入 + 部分费用）——用于 Q4/Q5 的关税收入分析。

---

## 二、关税数据库（tariff_database_xxxx）的统一清洗

### 1. 文件读取与拼接

**目标**：得到一个跨年面板 `tariff_panel`，粒度为（`year`, `hts8`）。

1. 读入所有 Excel 版关税文件（优先用 xlsx，避免 txt 的分隔符/编码问题）：

   * `tariff_database_2015.xlsx`, `tariff_database_2016.xlsx`, …,
   * `tariff_database_202010.xlsx`, `tariff database_202106.xlsx`, `tariff database_202207.xlsx`, `tariff database_202307.xlsx`, `tariff_database_202405.xlsx`, `tariff_database_2025.xlsx` 等。

2. 对每个文件：

   * 读入时指定 `dtype={"hts8": str}`，避免数值化丢前导零。2025 文件现在读出来是 `1012100` 这种，就得强制转字符串再补零。
   * 从文件名或元数据中解析 `year`：

     * `tariff_database_2015.xlsx` → 2015
     * `tariff_database_202010.xlsx` → 2020（只要你统一规定“2020 年代表 Reciprocal Tariffs 前的基准”，即可）
     * `tariff_database_2025.xlsx` → 2025（特朗普二任期 + Reciprocal Tariffs 情景）
   * 新增列：

     * `hts8 = hts8.str.zfill(8)`
     * `hs2 = hts8.str[:2]`
     * `hs4 = hts8.str[:4]`
     * `hs6 = hts8.str[:6]`
     * `year = year`

3. 把所有年度拼成一张长表 `tariff_raw_allyears`。

> 关税字段名在 `USITC Tariff Database Fields` 中有完整定义，与你附件中的字段一一对应。

### 2. 选择核心字段 & 对齐不同年度结构

不同年份字段数量略不一样（比如后期才出现 `nepal_indicator`、`japan_indicator`、`usmca_*` 等）。

建议拆成两层：

#### （1）核心字段（所有年份都有，五题必用）

* 商品与单位：

  * `hts8`, `brief_description`, `quantity_1_code`, `quantity_2_code`
* MFN 关税：

  * `mfn_text_rate`, `mfn_rate_type_code`, `mfn_ad_val_rate`, `mfn_specific_rate`, `mfn_other_rate`
* 其他：

  * `wto_binding_code`（是否有世贸绑定约束）
  * `col2_text_rate`, `col2_rate_type_code`, `col2_ad_val_rate`, `col2_specific_rate`, `col2_other_rate`（列2税率，多数情况下是“对不享 MFN 的国家”，可在 Q5 场景里选择性使用）
  * `additional_duty`（Yes/No：是否还有附加税，如 301 关税；不是税率本身）
  * `begin_effect_date`, `end_effective_date`

#### （2）FTA / 特惠计划字段（可选）

* 例如：`nafta_canada_ind`, `nafta_mexico_ind`, `korea_indicator`, `peru_indicator`, `australia_indicator` 等，以及对应的 `*_rate_type_code`, `*_ad_val_rate`, `*_specific_rate`。

清洗时：

* 对**所有年份**统一保留完整字段集合（把缺失的列补出来，填 `NaN`）。
* 核心分析如果暂不考虑各类 FTA，可以先只用 MFN 部分；需要模拟日本、墨西哥等国家“FTA vs Reciprocal Tariffs 对比”时，再用这些字段。

### 3. 类型转换与标准化

对 `tariff_raw_allyears` 做统一类型转换：

1. **编码类**

   * `hts8`/`hs2`/…：字符串。
   * `quantity_1_code`, `quantity_2_code`, `wto_binding_code`：字符串。
   * 各种 `*_indicator`：字符串或分类变量（A/B/C/0…）。
2. **税率类**

   * `mfn_ad_val_rate` 等 rate 字段本身在数据里就是 0–1 之间的小数（例如 4.5% 对应 0.045），直接转 float 即可。
   * `mfn_rate_type_code`、各 FTA 的 `*_rate_type_code`：整数型，含义按 `td-codes.pdf` 中的 A 部分映射（0=0税率；1=specific*Q1；4=specific*Q1+adval*Value 等）。([USITC][3])
   * 文本字段 `mfn_text_rate`, `col2_text_rate` 留作核查，不参与数值计算。
3. **时间**

   * `begin_effect_date`, `end_effective_date`：解析为日期。默认 `end_effective_date=2050-12-31` 可以视作“开放区间”。
4. **布尔类**

   * `additional_duty`：建议转为 0/1：

     * `Yes` → 1；`No` 或空值 → 0。

### 4. 按年度选取唯一的（year, hts8）记录

Tariff DB 记录的是“生效区间”，同一个 `hts8` 可能有多条不同的 begin/end。

为了做年度模型，需要把它变成**一年的“代表税率”**：

1. 对每个 `year` 和 `hts8`：

   * 计算当年中点 `mid_date = year-06-30`。
   * 选出满足
     `begin_effect_date <= mid_date <= end_effective_date` 的记录；
   * 如果有多条，选 `begin_effect_date` 最大的那条（最近的一次调整）。
2. 若没有任何记录覆盖中点：

   * 退而选 `begin_effect_date` 最近且 `begin_effect_date <= year-12-31` 的那条。

得到 `tariff_yearly`：**每年每个 HTS8 唯一一条记录**，字段包括 MFN 及主要 FTA 税率。

### 5. 构造通用关税变量视图

为了后面五个问题共用，建议在 `tariff_yearly` 上构造一个“简化版视图”：

* `mfn_adval` = `mfn_ad_val_rate`
* `mfn_spec_q1` = `mfn_specific_rate`（结合 `quantity_1_code`）
* `mfn_other` = `mfn_other_rate`
* `has_additional_duty` = (`additional_duty == 1`)

再额外加上：

* `hs2`, `hs4`, `hs6`（已经有了）
* `sector`：根据 HS2/HS4 自己定义的产业分类，如：

  * 农产品（01–24）
  * 制造业（25–97）
  * 其中再细分“大豆 HS 1201”“汽车 HS 8703/8704”“芯片 HS 8541/8542”等（这一步多半在题目具体部分再做）。

---

## 三、DataWeb 贸易数据的统一清洗

你给的两个 Excel：

* `DataWeb-Query-Export.xlsx`：

  * sheet `Query Parameters`：元数据
  * sheet `FAS Value`：美国对世界 Total Exports（HTS Items，Annual，FAS Value，2020–2025）
* `DataWeb-Query-Import.xlsx`：

  * `Query Parameters`
  * `General Import Charges`：美国 General Imports 的关税及相关收费（General Import Charges，2020–2025）

这两张数据结构几乎完全一样，只是“度量”不同。

### 1. 去掉头两行+标准化列名

以 `FAS Value` 为例（`General Import Charges` 完全一样处理）：

原始结构大致是：

* 第 0 行：`Data Row Count`（数据条数，元信息）
* 第 1 行：`Data Type`（说明各列含义）
* 第 2 行开始：真实数据，例如：

| col0      | col1       | col2        | col3    | col4(2020) | col5(2021)… |
| --------- | ---------- | ----------- | ------- | ---------- | ----------- |
| FAS Value | HTS Number | Description | Country | 2020       | …           |

清洗步骤：

1. 丢弃前两行（0/1），从第 2 行开始作为数据。

2. 重命名列：

   * 原第 0 列 `Total Exports|Annual Data` / `General Imports|Annual Data` → `measure_type`（值会是 `FAS Value` 或 `General Import Charges`）。
   * `Unnamed: 1` → `hts_number`（DataWeb 查询时选择的是 “HTS Items”，此列可能是 2 位、4 位或 6 位编码；样本文件是 2 位章码 `01`）。
   * `Unnamed: 2` → `description`
   * `Unnamed: 3` → `country`
   * `Unnamed: 4`~`Unnamed: 9` → 年度 `2020`~`2025`（转列名为字符串 `'2020'` 等）。

3. `hts_number` 保留为字符串并左补零到 2/4/6 位：

   * 如果你只做 2 位章级分析：`hs2 = hts_number.zfill(2)`
   * 若后面再从 DataWeb 下载更细粒度（HS8），同样道理。

4. 去掉 `measure_type` 这一列或重编码：

   * 对 `FAS Value` 文件：添加一列 `metric = "export_fas"`；
   * 对 `General Import Charges` 文件：`metric = "import_duty"`。

### 2. 宽表转长表（年度展开）

为了便于和关税以及其他宏观变量合并，应把 2020–2025 的列融成一列 `year`，一列 `value`：

1. 对每个文件做 `melt` 操作，伪代码：

```python
id_vars = ["hts_number", "description", "country", "metric"]
value_vars = ["2020", "2021", "2022", "2023", "2024", "2025"]

df_long = df.melt(id_vars=id_vars,
                  value_vars=value_vars,
                  var_name="year",
                  value_name="value")
df_long["year"] = df_long["year"].astype(int)
df_long["value"] = df_long["value"].fillna(0).astype(float)
```

2. 得到两张长表：

   * `exports_long(year, hts_number, country, value)`，其中 `metric="export_fas"`
   * `duties_long(year, hts_number, country, value)`，其中 `metric="import_duty"`

3. 标准化字段名（便于后续合并）：

   * `hts2 = hts_number.str.zfill(2)`（章级别）；如果后面改用 HS4/HS6，同样处理。
   * `partner_name = country`，再通过外部国家映射表增加 `partner_iso3`。

> FAS 和 General Import Charges 的定义可直接参考 DataWeb 官方说明：FAS 是出口在离岸点按交易价格计值；General Import Charges 是关税及相关收费。([DataWeb][2])

### 3. 异常值和一致性检查

* 检查所有 `value` ≥ 0；负值或极大值可标为异常待核查。
* 校验行数是否等于 `Data Row Count` 声明的数值（从第一行读取）。
* 对同一 `year, hts2, partner` 是否存在重复行：

  * 若有，检查是否是多指标（比如将来你再加 CIF Value 同时导入），必要时再加 `metric` 维度区分。

---

## 四、关税与贸易数据的统一整合

为了让五个问题共用一套“主数据”，建议做下面两层整合。

### 1. 把 HTS8 关税汇总到 HS2/HS4

因为附件中的贸易数据粒度是章级（HTS Number=01 等），而关税是 HTS8，需要做向上聚合：

1. 从 `tariff_yearly` 中选择核心字段：

   * `year, hts8, hs2, hs4, mfn_adval, mfn_spec_q1, mfn_other, has_additional_duty`
2. 按 `year, hs2` 聚合，构造 HS2 水平的 MFN 关税指标：

   * 最简单的做法（基础清洗阶段）用**简单平均**：

     * `mfn_adval_hs2 = mean(mfn_adval)`
   * 如果你将来从 DataWeb 另下“按 HTS8 的进口额”，可以在建模阶段改成**进口额加权平均**。
3. 同理可以聚合到 `hs4` 级别，以备大豆（1201）、汽车（8703/8704）、芯片（8542）等更细分行业分析用。

得到 `tariff_hs2_panel(year, hs2, mfn_adval_hs2, ...)`。

### 2. 将关税信息并入贸易数据

#### （1）出口侧（给 Q1/Q2/Q3/Q5 用）

* 从 `exports_long` 生成：

  * `year, hs2, partner, export_fas`
* 左连接 `tariff_hs2_panel`：

  * `key = (year, hs2)`
  * 得到 `trade_export_panel(year, hs2, partner, export_fas, mfn_adval_hs2, ...)`

#### （2）进口关税收入（给 Q4/Q5 用）

* 类似地，从 `duties_long` 得到：

  * `year, hs2, partner, import_duty`
* 汇总出：

  * 全国关税收入：`duty_total_year = sum(import_duty)`（按年汇总，后面可用来对照 USITC 公布总关税收入）。
  * 分行业关税收入：`duty_by_hs2_year = sum(import_duty by hs2)`。
* 将 `tariff_hs2_panel` 并入，用于构建“税率变化 → 收入变化”的弹性模型。

最终你会有几张基础表：

1. `tariff_hs2_panel`：关税（年 × HS2）
2. `trade_export_panel`：出口+关税（年 × HS2 × 国家）
3. `trade_duty_panel`：关税收入+关税率（年 × HS2 × 国家）
4. 若再需要，还可以保留最原始的 `tariff_yearly`（年 × HTS8）供特定行业精细分析。

---

## 五、五个问题共用的“预派生变量”建议

这些严格来说已经是“轻度特征工程”，但强烈建议在基础清洗阶段就统一好，后续所有题目都可以直接调用。

1. **产业标签 sector_industry**

   * 基于 HS2/HS4 定一张字典表，如：

     * 大豆：`hs4 == "1201"` → `sector="soybean"`
     * 乘用车：`hs4 in {"8703", "8704"}` → `sector="auto"`
     * 芯片：`hs4 in {"8541", "8542"}` → `sector="semiconductor"`
   * 把这张字典 merge 到 `tariff_yearly` 和所有贸易面板上（按 `hs4` 或 `hs2`）。
2. **合计变量（便于回归/校验）**

   * `export_fas_US_to_China_year_sector`：按（year, sector, partner=="China"）汇总出口；给 Q1/Q3/Q5 用。
   * `duty_US_total_year`：按年汇总全部 `import_duty`；给 Q4 做收入时间序列。
   * `duty_US_by_sector_year`：按（year, sector）汇总；给 Q5 做产业层面的冲击评估。
3. **平均税率（可选）**

   * 如果你再从 DataWeb 下载“General Imports – Customs Value/CIF Value”，可以在基础清洗中统一定义：

     * `avg_tariff_realized = import_duty / import_value`（按年 × HS2 × 国）
   * 这直接为 Q4/Q5 提供“实际有效税率”指标。

---

## 六、数据质量与文档化

最后，为了后续推模型不踩坑，建议在清洗脚本里做几件事：

1. **一致性检查**

   * 检查关税：`0 <= mfn_adval <= 1.0`；同时随机抽几条对照 `mfn_text_rate` 是否一致。([USITC][1])
   * 检查 `rate_type_code` 是否都出现在 `td-codes.pdf` 给出的合法值集合内。([USITC][3])
   * 汇总 `import_duty`，和 USITC 公布的全国关税收入总额做数量级对比。([USITC][4])
2. **版本与来源记录**

   * 在每张清洗后表的元数据里写清：

     * 原始文件名（含日期，如 `tariff_database_202405.xlsx`）
     * 清洗日期
     * 使用到的字段列表与含义（直接引用 `td-fields.pdf`）
3. **脚本结构**

   * 建议一个项目结构：

     * `01_read_raw_tariffs.py`：所有年度关税的读取+拼接+年度化
     * `02_read_raw_trade.py`：FAS+Import Charges 的读取+长表转换
     * `03_build_panels.py`：构造 `tariff_hs2_panel`、`trade_export_panel`、`trade_duty_panel`
     * `04_checks_and_summaries.py`：输出若干基础统计表/图，供论文引用。

---

如果你愿意，我可以在下一步直接帮你把上面这套清洗逻辑写成一份可运行的 Python 脚本模板（读你这些具体文件名、输出几张 csv），你只需要在本地稍微改路径就能跑。

[1]: https://www.usitc.gov/applications/dataweb/td-fields.pdf?utm_source=chatgpt.com "USITC Tariff Database Fields"
[2]: https://dataweb.usitc.gov/trade?utm_source=chatgpt.com "Data Request | DataWeb"
[3]: https://www.usitc.gov/applications/dataweb/td-codes.pdf?utm_source=chatgpt.com "Tariff Database Code Key - usitc.gov"
[4]: https://www.usitc.gov/open_data.htm?utm_source=chatgpt.com "Open Data - United States International Trade Commission"
